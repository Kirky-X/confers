name: Release

on:
  push:
    tags:
      - 'v*.*.*'

env:
  CARGO_TERM_COLOR: always

jobs:
  # 构建多平台二进制文件并创建 GitHub Release
  build-and-release:
    name: Build and Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    strategy:
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest

          - target: aarch64-unknown-linux-gnu
            os: ubuntu-latest
            cross: true

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get version from tag
        id: get_version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install cross-compilation tools
        if: matrix.cross
        run: |
          cargo install cross --git https://github.com/cross-rs/cross

      - name: Build binaries
        run: |
          if [ "${{ matrix.cross }}" = "true" ]; then
            cross build --release --target ${{ matrix.target }} --bins
          else
            cargo build --release --target ${{ matrix.target }} --bins
          fi

      - name: Package binaries
        run: |
          mkdir -p release-assets
          cd target/${{ matrix.target }}/release

          # 查找所有二进制文件（排除 .d 文件和库文件）
          for binary in $(find . -maxdepth 1 -type f -executable ! -name "*.d" ! -name "*.so" ! -name "*.dylib" ! -name "*.dll"); do
            binary_name=$(basename "$binary")
            # 创建 tar.gz 包
            tar czf "../../../release-assets/${binary_name}-${{ steps.get_version.outputs.version }}-${{ matrix.target }}.tar.gz" "$binary_name"

            # 生成 SHA256
            sha256sum "$binary_name" | awk '{print $1}' > "../../../release-assets/${binary_name}-${{ steps.get_version.outputs.version }}-${{ matrix.target }}.tar.gz.sha256"
          done

      - name: Generate changelog
        id: changelog
        run: |
          VERSION=${{ steps.get_version.outputs.version }}

          # 获取上一个 tag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          echo "content<<EOF" >> $GITHUB_OUTPUT
          echo "## What's Changed" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT

          if [ -n "$PREV_TAG" ]; then
            git log $PREV_TAG..HEAD --pretty=format:"- %s (%h)" >> $GITHUB_OUTPUT
          else
            git log --pretty=format:"- %s (%h)" >> $GITHUB_OUTPUT
          fi

          echo "" >> $GITHUB_OUTPUT
          echo "## Assets" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "### Binaries" >> $GITHUB_OUTPUT
          ls release-assets/*.tar.gz | while read file; do
            basename_file=$(basename "$file")
            echo "- \`$basename_file\`" >> $GITHUB_OUTPUT
          done
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: release-assets/*
          body: "${{ steps.changelog.outputs.content }}"
          draft: false
          prerelease: false
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # 发布到 crates.io
  publish-crates:
    name: Publish to crates.io
    runs-on: ubuntu-latest
    environment:
      name: crates.io
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get version from tag
        id: get_version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Publish macros crate first
        run: |
          cd macros
          cargo publish --token ${{ secrets.CARGO_REGISTRY_TOKEN }}
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}

      - name: Wait for crates.io index update
        run: sleep 10

      - name: Publish main crate
        run: |
          cargo publish --token ${{ secrets.CARGO_REGISTRY_TOKEN }}
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}